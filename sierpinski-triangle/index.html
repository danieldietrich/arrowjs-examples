<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sierpinski Triangle</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="arrow,arrowjs,sierpinski,triangle">
    <meta name="author" content="Daniel Dietrich">
    <link rel="stylesheet" href="./styles.css">
    <!--style>
      * {
          animation: flash 500ms ease;
      }
      @keyframes flash {
          from {
              box-shadow: inset 0 0 2px 2px fuchsia, 0 0 2px 2px fuchsia;
          }
      }
    </style-->
</head>

<body>
    <noscript>
        You need to enable JavaScript to run this app.
    </noscript>
    <div id="background"></div>
    <div id="app"></div>
    <script type="module">
        import { comp, html, render, useEffect, useLayoutEffect, useState } from 'https://unpkg.com/@danieldietrich/arrowjs?module'

        const useWindowSize = () => {
          const [size, setSize] = useState({ width: 0, height: 0 })
          useLayoutEffect(() => {
            const handleResize = () => setSize({ width: window.innerWidth, height: window.innerHeight })
            window.addEventListener("resize", handleResize)
            handleResize()
            return () => window.removeEventListener("resize", handleResize)
          }, [])
          return size
        }

        const dy = Math.sin(Math.PI / 2)

        const Triangle = comp(({depth, num, x, y, w, h}) => {
          const w2 = w / 2
          if (depth <= 0) {
            // in this case it is allowed to use hooks in an if-condition because depth is constant
            const [label, setLabel] = useState(num)
            useEffect(() => { // TODO: make useEffect faster by using Promise and shimming setTimeout(f)
              setLabel(num)
            }, [num])
            return html`
                <svg style="position: absolute; top: ${y}; left: ${x - w2}; width: ${w}; height: ${h}" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                  <polygon class="triangle" points="50 0, 100 100, 0 100" vector-effect="non-scaling-stroke" />
                  <text class="triangle-text" x="29" y="72" fill="FloralWhite">${label}</text>
                </svg>
            `
          } else {
            const w4 = w / 4, h2 = h / 2
            depth--
            return html`
              ${Triangle({ depth, num, x, y, w: w2, h: h2 })}
              ${Triangle({ depth, num, x: x - w4, y: y + dy * h2, w: w2, h: h2 })}
              ${Triangle({ depth, num, x: x + w4, y: y + dy * h2, w: w2, h: h2 })}
            `
          }
        })

        const numerus = (i, s) => String(i) + ' ' + (i <= 1 ? s : s + 's')

        const defer = typeof Promise === 'function' ? Promise.resolve().then.bind(Promise.resolve()) : setTimeout

        const computeSize = (w, h, f) => ({ x: w * (1 - f) / 2 + w * f / 2, y: 0, w: w * f, h })

        const ease = t => (Math.sin(Math.PI * 2 * t) + 1)/2

        let fpsAcc = 0, fpsCount = 0

        // Render the whole president table
        const SierpinskiTriangle = comp(() => {

          const { width, height } = useWindowSize()
          const [depth, setDepth] = useState(5)
          const [speed, setSpeed] = useState(100)
          const [factor, setFactor] = useState(1)
          const [millis, setMillis] = useState(0)
          const [fps, setFps] = useState(0)
          const components = Math.trunc((1 - Math.pow(3, Math.trunc(depth) + 1)) / (1 - 3)) // we have Sum_0..n(3^n) components, see https://en.wikipedia.org/wiki/Geometric_series

          useEffect(() => {
            defer(() => {
              const now = Date.now()
              fpsAcc += 1000 / (now - millis)
              if (++fpsCount >= 8) {
                setFps(Math.trunc(fpsAcc / fpsCount))
                fpsAcc = fpsCount = 0
              }
              setMillis(now)
              setFactor(ease((now / speed) % 100 / 100))
            })
          }, [factor])
          
          return html`
              <div id="stats">
                <div class="fps">${fps} fps</div>
                <div class="stat">${width} x ${height} px</div>
                <div class="stat">${numerus(components, 'component')}</div>
                <div class="stat">${numerus(components * 3, 'node')}</div>
              </div>
              <div id="controls">
                <div class="control">
                  <label for="depth">Depth</label>
                  <input id="depth" type="range" min="0" max="7" step="1" value="${depth}" onchange=${(e) => setDepth(e.target.value)}></input>
                </div>
                <div class="control">
                  <label for="speed">Speed</label>
                  <input id="speed" type="range" min="1" max="100" step="1" value="${101 - Math.log(speed)/Math.log(1.08)}" onchange=${(e) => setSpeed(Math.pow(1.08, 101 - e.target.value))}></input>
                </div>
              </div>
              <div id="triangle"><!--style="transform: rotate(${factor * 360}deg)"-->
                ${width * height > 0 && Triangle({depth, num: Math.trunc(factor * 100), ...computeSize(width, height, factor)})}
              </div>
          `
        })

        // Entry point: mount president table to DOM
        render(SierpinskiTriangle(), document.getElementById('app'))

    </script>
</body>

</html>